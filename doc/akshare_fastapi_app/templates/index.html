
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AkShare FastAPI Visualizer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        #results-table thead {
            position: sticky;
            top: 0;
            background: white;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">AkShare FastAPI Visualizer</h1>

        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Controls</h5>
                        <div class="mb-3">
                            <label for="function-select" class="form-label">Select AkShare Function</label>
                            <select id="function-select" class="form-select">
                                <option selected>Choose...</option>
                            </select>
                        </div>
                        <div id="params-container"></div>
                        <button id="run-button" class="btn btn-primary">Run</button>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Results</h5>
                        <div id="chart-controls" class="row mb-3 align-items-center" style="display: none;">
                            <div class="col-auto">
                                <label for="chart-type-select" class="form-label">Chart Type</label>
                                <select id="chart-type-select" class="form-select form-select-sm">
                                    <option value="line">Line</option>
                                    <option value="bar">Bar</option>
                                </select>
                            </div>
                            <div class="col-auto">
                                <button id="redraw-chart-button" class="btn btn-secondary btn-sm">Redraw Chart</button>
                            </div>
                            <div class="col">
                                <div id="column-select-container" class="d-flex flex-wrap"></div>
                            </div>
                        </div>
                        <canvas id="chart-container" style="display: none; max-height: 400px;"></canvas>
                        <div id="results-container" style="max-height: 600px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let functions = [];
        let myChart;
        let chartableData = [];

        document.addEventListener('DOMContentLoaded', function() {
            const functionSelect = document.getElementById('function-select');
            const paramsContainer = document.getElementById('params-container');
            const runButton = document.getElementById('run-button');
            const resultsContainer = document.getElementById('results-container');
            const chartContainer = document.getElementById('chart-container');
            const chartControls = document.getElementById('chart-controls');
            const columnSelectContainer = document.getElementById('column-select-container');
            const redrawChartButton = document.getElementById('redraw-chart-button');

            // Fetch the list of functions from the backend
            fetch('/api/functions')
                .then(response => response.json())
                .then(data => {
                    functions = data.functions;
                    // Filter out any potentially problematic entries
                    functions = functions.filter(f => f && f['功能点']);
                    functions.forEach((func, index) => {
                        const option = document.createElement('option');
                        option.value = index;
                        option.textContent = func['功能点'];
                        functionSelect.appendChild(option);
                    });
                });

            functionSelect.addEventListener('change', function() {
                paramsContainer.innerHTML = '';
                const selectedIndex = this.value;
                if (!selectedIndex || selectedIndex === 'Choose...') return;

                const selectedFunction = functions[selectedIndex];
                const paramsString = selectedFunction['主要参数'];
                if (paramsString) {
                    // Improved parameter parsing
                    const params = paramsString.split(/[,;]/).map(p => p.trim());
                    params.forEach(param => {
                        if (!param) return;
                        const [paramName, defaultValue] = param.split('=').map(p => p.trim());
                        const div = document.createElement('div');
                        div.classList.add('mb-3');
                        const label = document.createElement('label');
                        label.textContent = paramName;
                        label.classList.add('form-label');
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.classList.add('form-control');
                        input.name = paramName;
                        if (defaultValue) {
                            input.value = defaultValue.replace(/['"]/g, "");
                        }
                        div.appendChild(label);
                        div.appendChild(input);
                        paramsContainer.appendChild(div);
                    });
                }
            });

            runButton.addEventListener('click', function() {
                const selectedIndex = functionSelect.value;
                if (!selectedIndex || selectedIndex === 'Choose...') return;

                const selectedFunction = functions[selectedIndex];
                const functionName = selectedFunction['AkShare函数'].trim();
                const inputs = paramsContainer.getElementsByTagName('input');
                const queryParams = new URLSearchParams();
                for (let input of inputs) {
                    if (input.value) {
                        queryParams.append(input.name, input.value);
                    }
                }

                resultsContainer.innerHTML = '<div class="d-flex justify-content-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
                chartContainer.style.display = 'none';
                chartControls.style.display = 'none';
                columnSelectContainer.innerHTML = '';
                if (myChart) {
                    myChart.destroy();
                }

                fetch(`/api/call/${functionName}?${queryParams.toString()}`)
                    .then(response => response.json())
                    .then(data => {
                        resultsContainer.innerHTML = '';
                        if (data.error) {
                            resultsContainer.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                        } else {
                            chartableData = (Array.isArray(data) && data.length > 0) ? data : [];
                            renderData(data);
                        }
                    })
                    .catch(error => {
                        resultsContainer.innerHTML = `<div class="alert alert-danger">Error: ${error}</div>`;
                    });
            });
            
            redrawChartButton.addEventListener('click', function(){
                renderChart(chartableData);
            });

            function renderData(data) {
                if (Array.isArray(data) && data.length > 0) {
                    renderTable(data);
                    if (isChartable(data)) {
                        chartControls.style.display = 'flex';
                        chartContainer.style.display = 'block';
                        populateColumnSelector(data);
                        renderChart(data);
                    }
                } else if (typeof data === 'object' && data !== null) {
                     renderTable([data]);
                } else {
                    resultsContainer.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                }
            }

            function isChartable(data) {
                if (!data || data.length === 0) return false;
                const keys = Object.keys(data[0]);
                const hasDateOrTimeSeriesKey = keys.some(k => ['date', '日期', 'time', '时间', 'datetime'].includes(k.toLowerCase()));
                const hasNumericKey = keys.some(k => typeof data[0][k] === 'number');
                return hasDateOrTimeSeriesKey && hasNumericKey;
            }

            function populateColumnSelector(data) {
                columnSelectContainer.innerHTML = '';
                const keys = Object.keys(data[0]);
                let firstNumericFound = false;
                keys.forEach(key => {
                    if (typeof data[0][key] === 'number') {
                        const div = document.createElement('div');
                        div.classList.add('form-check', 'form-check-inline');
                        const input = document.createElement('input');
                        input.classList.add('form-check-input');
                        input.type = 'checkbox';
                        input.value = key;
                        input.id = `check-${key}`;
                        if (!firstNumericFound) {
                            input.checked = true;
                            firstNumericFound = true;
                        }
                        const label = document.createElement('label');
                        label.classList.add('form-check-label');
                        label.htmlFor = `check-${key}`;
                        label.textContent = key;
                        div.appendChild(input);
                        div.appendChild(label);
                        columnSelectContainer.appendChild(div);
                    }
                });
            }

            function renderChart(data) {
                if (myChart) {
                    myChart.destroy();
                }
                
                const chartType = document.getElementById('chart-type-select').value;
                const selectedColumns = Array.from(columnSelectContainer.querySelectorAll('input:checked')).map(input => input.value);
                if (selectedColumns.length === 0) return;

                const ctx = chartContainer.getContext('2d');
                const dateKey = Object.keys(data[0]).find(k => ['date', '日期', 'time', '时间', 'datetime'].includes(k.toLowerCase()));
                const labels = data.map(item => item[dateKey]);
                
                const datasets = selectedColumns.map(key => {
                    return {
                        label: key,
                        data: data.map(item => item[key]),
                        fill: false,
                        borderColor: `rgb(${Math.floor(Math.random() * 200 + 55)}, ${Math.floor(Math.random() * 200 + 55)}, ${Math.floor(Math.random() * 200 + 55)})`,
                        tension: 0.1
                    };
                });

                myChart = new Chart(ctx, {
                    type: chartType,
                    data: {
                        labels: labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: dateKey || 'Index'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Value'
                                }
                            }
                        }
                    }
                });
            }

            function renderTable(data) {
                const table = document.createElement('table');
                table.id = 'results-table';
                table.classList.add('table', 'table-striped', 'table-bordered', 'table-sm');
                const thead = document.createElement('thead');
                const tbody = document.createElement('tbody');
                const headerRow = document.createElement('tr');

                Object.keys(data[0]).forEach(key => {
                    const th = document.createElement('th');
                    th.textContent = key;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);

                data.forEach(item => {
                    const row = document.createElement('tr');
                    Object.values(item).forEach(value => {
                        const td = document.createElement('td');
                        td.textContent = (value === null || typeof value === 'undefined') ? '' : value;
                        row.appendChild(td);
                    });
                    tbody.appendChild(row);
                });

                table.appendChild(thead);
                table.appendChild(tbody);
                resultsContainer.appendChild(table);
            }
        });
    </script>
</body>
</html>
