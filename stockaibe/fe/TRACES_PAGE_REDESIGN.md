# 请求追踪页面重新设计

## 概述

重新设计了请求追踪页面，分为3个Tab页面，提供更全面的数据展示和分析功能。

## 页面结构

### Tab 1: 统计图表 📊

展示两个核心统计图表：

1. **配额状态统计**
   - 分组柱状图展示每个配额的3种状态数量
   - 绿色：成功（200）
   - 红色：失败（500）
   - 黄色：限流（429）
   - 数据来源：`/api/metrics/current`

2. **函数调用次数 TOP 10**
   - 柱状图展示调用次数最多的前10个函数
   - 顶部显示具体数值
   - 按调用次数降序排列
   - 数据来源：`/api/traces/func-stats`

### Tab 2: 请求追踪 📋

详细的请求追踪列表，包含以下字段：

- **ID**: 追踪记录ID
- **配额ID**: 使用的配额标识
- **函数名称**: 调用的限流函数名称（新增）
- **状态**: 成功/失败/限流（带颜色标签）
- **延迟**: 请求延迟（毫秒），超过1秒显示红色
- **消息**: 详细信息
- **时间**: 创建时间

特性：
- 自动刷新（每5秒）
- 分页显示（每页20条）
- 水平滚动支持

### Tab 3: 函数调用统计 🔧

统计每个限流函数的调用情况，包含以下字段：

- **函数ID**: 函数唯一标识
- **函数名称**: 函数显示名称
- **配额ID**: 关联的配额
- **总调用**: 总调用次数（可排序）
- **成功**: 成功次数（绿色标签）
- **失败**: 失败次数（红色标签）
- **被限流**: 被限流次数（黄色标签）
- **成功率**: 计算公式：成功次数 / 总调用次数 × 100%
- **平均延迟**: 平均响应时间（毫秒）
- **最后调用**: 最后一次调用时间

特性：
- 按总调用次数排序
- 自动刷新（每5秒）
- 分页显示（每页20条）
- 水平滚动支持

## 功能按钮

页面顶部提供以下操作：

1. **刷新**: 手动刷新所有数据
2. **删除非当天数据**: 删除今天之前的所有追踪记录
3. **一键删除全部**: 删除所有追踪记录（包括今天）

## 技术实现

### 前端修改

1. **类型定义** (`types/api.ts`)
   - 在 `Trace` 接口添加 `func_id` 和 `func_name` 字段
   - 新增 `FuncStats` 接口

2. **API 客户端** (`api/client.ts`)
   - 新增 `getFuncStats()` 方法

3. **页面组件** (`pages/Traces.tsx`)
   - 使用 Ant Design Tabs 组件
   - 集成 @ant-design/plots 图表库
   - 3个独立的数据加载函数
   - 统一的自动刷新机制

### 后端支持

需要确保以下 API 端点可用：

- `GET /api/traces` - 获取追踪列表
- `GET /api/traces/func-stats` - 获取函数统计
- `GET /api/metrics/current` - 获取当前指标
- `DELETE /api/traces/all` - 删除所有记录
- `DELETE /api/traces/old` - 删除旧记录

## 数据流

```
页面加载
  ↓
并行加载3种数据
  ├─ loadTraces() → traces
  ├─ loadFuncStats() → funcStats
  └─ loadMetrics() → metricsData
  ↓
每5秒自动刷新
  ↓
数据更新 → 图表/表格自动刷新
```

## 使用说明

1. **查看统计**: 默认打开"统计图表"Tab，查看整体数据分布
2. **追踪请求**: 切换到"请求追踪"Tab，查看详细的请求记录
3. **分析函数**: 切换到"函数调用统计"Tab，分析每个函数的性能
4. **数据清理**: 使用删除按钮清理历史数据

## 注意事项

1. 页面会每5秒自动刷新数据
2. 图表仅显示 TOP 10 函数（按调用次数）
3. 删除操作不可恢复，请谨慎操作
4. 需要先运行数据库迁移脚本添加 `func_id` 和 `func_name` 字段
